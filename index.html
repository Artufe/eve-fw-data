<!DOCTYPE html>
<html>
<head>
    <title>Eve Faction Warfare Dashboard</title>
    <style type="text/css">
      html {
        -webkit-text-size-adjust: 100%; 
        -moz-text-size-adjust: 100%; 
        -ms-text-size-adjust: 100%;
      }

      body {
         font-family: Arial,sans-serif;
         background: #000;
         margin: 0;
         padding: 0;
      }
      div {
        margin:0;
      }
      a {
         color: #2980b9;
         text-decoration: none;
         font-weight: bold;
      }
      a:hover {
        color: #00aeff;
      }
      h1, h2, h3, .times {
        text-transform: uppercase;
        color: #fff;
        margin-top: 0;
        padding-top: 20px;
      }
      h1, h2, h3 {
        clear: both;
      }
      .white-text {
        color: #fff;
      }

      .title {
        padding: 5px 10px;
        background-color: #fff;
        height:50px;
        overflow:hidden;
      }
      .title>h1 {
        float:left;
        color: #606060;
      }
      .title>p {
        margin-top: 28px;
        float: right;
        color: #606060;
      }

      .links{
        border-top: solid 1px #606060;
        color: #606060;
        text-transform: uppercase;
        padding: 1px 10px;
        background-color: #fff;
        font-size: 80%;
        float:left;
      }

      .times {
        float: right;
        display: inline;
        color: #606060;
        margin: 0;
        padding: 2px 10px;
        font-size: 80%;
      }

      .content {
        padding: 0 10px;
      }
      .heading-note{
        background-color: #ffffff;
        color: #606060;
        font-size: 85%;
        padding: 2px 10px 1px 10px;
        margin-bottom: 10px;
        margin-top: 10px;
        border-top: 1px solid #00aeff;
        border-bottom: 1px solid #00aeff;
      }
      .heading-note>b{
        text-transform: uppercase;
      }

      [data-href] {
        cursor: pointer;
      }

      .message {
        position: relative;
        width: 100%;
        height: 75px;
        overflow: hidden;
        margin: 5px 0;
      }
      .message, .message>div{
        padding: 0;
      }
      .message>p , .system-constellation>p, .system-region>p, .region>p, .constellation>p {
        width: 100%;
        text-align: center;
        padding: 0 5px;
        position: absolute;
        top: 0;
        margin: 5px;
      }
      .constellation>p {
        margin: 2px;
      }
      .system-constellation>p, .system-region>p, .region>p, .constellation>p {
        text-shadow: -1px 0 #fff, 0 1px #fff, 1px 0 #fff, 0 -1px #fff;
        color: #000;
      }

      .faction-div, .market-div {
        float: left;
        width: 49%;
      }
      .faction-div:nth-child(even), .market-div:nth-child(odd) {
        clear:both;
        margin-right: 1%;
      }
      .faction-div:nth-child(odd), .market-div:nth-child(even) {
        margin-left: 1%;
      }

      .faction-vp-progress, .faction-systems-progress, .faction-victory-index, .faction-kills-item, .faction-lp-exchange, .faction-lp-iskpersite {
        padding: 2px 1%;
        margin: 2px 0;
        height: 40px;
        overflow: visible;
        white-space: nowrap;
      }

      .faction-victory {
        position: relative;
      }

      .faction-victory-index {
        position: relative;
        margin:0px;
        border-top:solid 1px #000;
      }

      .faction-victory-index.positive {
        border-left: 3px solid #fff;
      }

      .faction-victory-index.negative {
        border-right: 3px solid #fff;
        text-align: right;
      }

      .region, .constellation {
        float: left;
        position:relative;
        padding: 0;
        margin:0;
        height: 32px;
      }
      .region {
        width: 50%;
      }
      .constellation {
        width: 25%;
      }

      .system-constellation>p, .system-region>p {
          margin-top: 0;
      }

      .system-constellation, .system-region {
          position: absolute;
          top: 45px;
          width: 50%;
          border-top:1px solid black;
      }
      .system-region {
          left: 50%;
          border-left:1px solid black;
      }

      .system-constellation>div, .system-region>div {
          position: relative;
          width: 100%;
          height: 15px;
      }

      .definition-label{
        text-transform: uppercase;
        display: block;
        line-height: 7px;
        font-size: 60%;
        text-shadow: none;
      }

      .system-owner-label{
        text-transform: uppercase;
        font-size: 80%;
      }

      .system-vp-progress {
        position: absolute;
        height: 45px;
      }

      .region-vp-progress, .constellation-vp-progress, .region-systems-progress, .constellation-systems-progress {
        height: 15px;
        float: left;
        font-size: 80%;
        text-transform: uppercase;
        overflow: hidden;
      }

      .region-vp-progress:nth-child(even), .constellation-vp-progress:nth-child(even), .region-systems-progress:nth-child(even), .constellation-systems-progress:nth-child(even) {
        text-align:right;
      }

      .region-vp-progress:nth-child(odd)::before, .constellation-vp-progress:nth-child(odd)::before, .region-systems-progress:nth-child(odd)::before, .constellation-systems-progress:nth-child(odd)::before {
        content: "..";
        visibility: hidden;
      }

      .region-vp-progress:nth-child(even)::after, .constellation-vp-progress:nth-child(even)::after, .region-systems-progress:nth-child(even)::after, .constellation-systems-progress:nth-child(even)::after {
        content: "..";
        visibility: hidden;
      }

      .occupier-minmatar {
        background: #e60000;
        color: #ffe6e6;
      }
      .occupier-minmatar>div {
        background: #cc9900;
      }
      .owner-minmatar {
        border: 3px solid #cc0000;
      }
      .occupier-amarr {
        background: #cc9900;
        color: #fff2cc;
      }
      .occupier-amarr>div {
        background: #e60000;
      }
      .owner-amarr {
        border: 3px solid #997300;
      }
      .occupier-caldari {
        background: #008fb3;
        color: #ccf5ff;
      }
      .occupier-caldari>div {
        background: #248f24;
      }
      .owner-caldari {
        border: 3px solid #008fb3;
      }
      .occupier-gallente {
        background: #248f24;
        color:#d6f5d6;
      }
      .occupier-gallente>div {
        background: #008fb3;
      }
      .owner-gallente {
        border: 3px solid #248f24;
      }
      
    </style>
</head>
<body>
  <div class="title">
    <h1>Eve Faction Warfare Dashboard</h1>
    <p>By <a href="https://gate.eveonline.com/Profile/DrButterfly%20PHD" target="_blank">DrButterfly PHD</a></p>
  </div>
  <div class="links">
    <b>Other FW sites: </b>
    <a href="https://forums.eveonline.com/default.aspx?g=posts&t=496584" target="_blank">Ushra'Khan Recruitment</a> 
    | <a href="http://evemaps.dotlan.net/factionwarfare" target="_blank">dotlan</a> 
    | <a href="http://map.jerkasauruswrecks.com/" target="_blank">Jerkasauruswrecks</a>
    | <a href="https://www.fuzzwork.co.uk/lpstore/" target="_blank">Fuzzwork</a>
    | <a href="https://eve-central.com/" target="_blank">EVE Central</a>
  </div><p class="times">&nbsp;</p>
  <div class="content">
  </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">
var factions = [
    'amarr',
    'minmatar',
    'gallente',
    'caldari'
  ];

var factionFullName = {
  'amarr': 'Amarr Empire',
  'minmatar': 'Minmatar Republic',
  'gallente': 'Gallente Federation',
  'caldari': 'Caldari State'
};

var factionShortlName = {
  'Amarr Empire' : 'amarr',
  'Minmatar Republic' : 'minmatar',
  'Gallente Federation' : 'gallente',
  'Caldari State': 'caldari'
};

var enemy = {
  'amarr': 'minmatar',
  'minmatar': 'amarr',
  'gallente': 'caldari',
  'caldari': 'gallente'
};

var dotlanMapURL = {
  'amarr': 'http://evemaps.dotlan.net/map/amarr_vs_minmatar/',
  'minmatar': 'http://evemaps.dotlan.net/map/amarr_vs_minmatar/',
  'caldari': 'http://evemaps.dotlan.net/map/caldari_vs_gallente/',
  'gallente': 'http://evemaps.dotlan.net/map/caldari_vs_gallente/',
};

var cachedUntil = null,
dataFrom = null,
fwSystemsList = null,
fwSystemsListBase = null,
factionStats = [];

$(function() {
  var jqxhr = $.get( "fw-systems.json", function(json) {
    fwSystemsListBase = json;
    fwSystemsList = fwSystemsListBase;
    ticker();
    setInterval(ticker, 5000);
  })
  .fail(function() {
    $('.content').html('<p>Error loading fw-systems.json</p>');
  });
});

function ticker(){
  var now = new Date();
  if (cachedUntil != null && now <= cachedUntil) {
    return;
  }

  // Reset everything
  $('.content').empty();
  fwSystemsList = JSON.parse(JSON.stringify(fwSystemsListBase));
  factionStats = [];

  var APIRequests = 2;
  var jqxhr = $.get( "https://api.eveonline.com/map/FacWarSystems.xml.aspx", function(xml) {
    APIRequests--;

    var systems = xmlToSystems(xml);
    console.log(systems);
    console.log(fwSystemsList);

    var vulnerableSystems = getSystems(systems, {min: 1, max: null}),
    highRiskSystems = getSystems(systems, {min: 0.90, max: 1}),
    contestedSystems = getSystems(systems, {min: 0.50, max: 0.90}),
    safeSystems = getSystems(systems, {min: 0.001, max: 0.50})
    uncontestedSystems = getSystems(systems, {min: 0.0, max: 0.001});
    
    $('.times').html('Fetched: '+dateToTimeString(dataFrom)+' | Next Update: '+dateToTimeString(cachedUntil));
    
    $('.content').append('<h2>Factions</h2>');
    outputFactions();
    $('.content').append('<h2>Regions</h2>');
    outputRegions();
    $('.content').append('<h2>Constellations</h2>');
    outputConstellations();
    $('.content').append('<h2>Systems</h2>');
    $('.content').append('<p class="heading-note">Systems are ordered and grouped by contested level, with any vulnerable systems listed first.</p>');
    outputSystems(vulnerableSystems, {name: 'Vulnerable Systems'});
    outputSystems(highRiskSystems, {name: 'Highly Contested Systems'});
    outputSystems(contestedSystems, {name: 'Contested Systems'});
    outputSystems(safeSystems, {name: 'Minimally Contested Systems'});
    outputSystems(uncontestedSystems, {name: 'Uncontested Systems'});

    $('[data-href]').click(function(){
      window.open($(this).attr('data-href'));
      return false;
    });

    if (APIRequests == 0){
      outputFactionStats();
    }
  })
  .fail(function() {
    $('.content').html('<p>Error communicating with the EVE API.</p>');
  });

  var jqxhr = $.get( "https://api.eveonline.com/eve/FacWarStats.xml.aspx", function(xml) {
    APIRequests--;
    var rowset = $(xml).find('rowset[name="factions"]');
    rowset.find('row').each(function(){
      var factionStat = {};
      $.each(this.attributes, function(i, attrib){
         factionStat[attrib.name] = attrib.value;
      });
      factionStats.push(factionStat);
    });
    if (APIRequests == 0){
      outputFactionStats();
    }
  })
  .fail(function() {
    $('.content').html('<p>Error communicating with the EVE API.</p>');
  });
}

function outputFactionStats(){
  console.log(factionStats);
  factionStats.sort(function(a, b) { 
      return b.killsYesterday - a.killsYesterday;
  });
  $.each(factionStats, function(index, factionStat){
    var width = factionStat.killsYesterday / factionStats[0].killsYesterday * 100;
    $('.faction-kills').append('<div class="faction-kills-item occupier-' 
    + factionShortlName[factionStat.factionName] + '" style="width: ' + (width - 2) + '%;">' 
    + factionStat.factionName + '<br/>' + factionStat.killsYesterday + '</div>');
  });
}

function xmlToSystems(xml){
  var systems = [];
  cachedUntil = new Date($(xml).find('cachedUntil').text() + 'Z');
  dataFrom = new Date($(xml).find('currentTime').text() + 'Z');
  $(xml).find('row').each(function(){
    var system = {};
    $.each(this.attributes, function(i, attrib){
       system[attrib.name] = attrib.value;
    });

    // Data tidy;
    system.victoryPoints = parseInt(system.victoryPoints);
    system.victoryPointThreshold = parseInt(system.victoryPointThreshold);
    if (system.occupyingFactionName == ''){
      system.occupyingFactionName = system.owningFactionName;
    }

    // Populate region and constellation data
    var region = fwSystemsList.systems[system.solarSystemName].region,
    constellation = fwSystemsList.systems[system.solarSystemName].constellation;
    populateStats(system, {type:'region', item: region});
    populateStats(system, {type:'constellation', item: constellation});
    populateStats(system, {type:'faction', item: 'totals'});

    systems.push(system);
  });
  calculateFactionPercentages();
  return systems;
}

function populateStats(system, cfg){
  var item = cfg.item, type = cfg.type;
  if (!fwSystemsList[type+'s'][item].hasOwnProperty('victoryPoints')){
    fwSystemsList[type+'s'][item].victoryPoints = {
      'amarr': 0,
      'minmatar': 0,
      'gallente': 0,
      'caldari': 0
    };
    fwSystemsList[type+'s'][item].victoryPointThreshold = 0;
    fwSystemsList[type+'s'][item].occupiedSystems = {
      'amarr': 0,
      'minmatar': 0,
      'gallente': 0,
      'caldari': 0
    };
    fwSystemsList[type+'s'][item].volatility = 0;
  }

  var defender = system.occupyingFactionName.split(' ')[0].toLowerCase();
  var attacker = enemy[defender];

  fwSystemsList[type+'s'][item].victoryPoints[attacker] += system.victoryPoints;
  fwSystemsList[type+'s'][item].victoryPoints[defender] += system.victoryPointThreshold - system.victoryPoints;
  fwSystemsList[type+'s'][item].volatility += system.victoryPoints;
  fwSystemsList[type+'s'][item].victoryPointThreshold += system.victoryPointThreshold;
  fwSystemsList[type+'s'][item].occupiedSystems[defender]++;
}

function calculateFactionPercentages (){
  fwSystemsList.factions.totals.victoryPointsPercent = {};
  $.each(enemy, function(faction, enemy){
    var factionDiv = $('<div class="system-faction"></div>');
    var maxVP = fwSystemsList.factions.totals.victoryPoints[faction] + fwSystemsList.factions.totals.victoryPoints[enemy];
    var width = 100 * (fwSystemsList.factions.totals.victoryPoints[faction] / maxVP);
    width = width > 100 ? 100 : width;
    fwSystemsList.factions.totals.victoryPointsPercent[faction] = width;
  });

  fwSystemsList.factions.totals.occupiedSystemsPercent = {};
  fwSystemsList.factions.totals.victoryIndex = {};
  $.each(enemy, function(faction, enemy){
    var factionDiv = $('<div class="system-faction"></div>');
    var maxSystems = fwSystemsList.factions.totals.occupiedSystems[faction] + fwSystemsList.factions.totals.occupiedSystems[enemy];
    var width = 100 * (fwSystemsList.factions.totals.occupiedSystems[faction] / maxSystems);
    width = width > 100 ? 100 : width;
    fwSystemsList.factions.totals.occupiedSystemsPercent[faction] = width;
    fwSystemsList.factions.totals.victoryIndex[faction] = fwSystemsList.factions.totals.victoryPointsPercent[faction] - fwSystemsList.factions.totals.occupiedSystemsPercent[faction];
  });
}

function getSystems(systems, cfg){
  var filteredSystems = [];
  $.each(systems, function(index, system){
    if (
      system.victoryPoints >= (system.victoryPointThreshold * cfg.min) 
      && (system.victoryPoints < (system.victoryPointThreshold * cfg.max) || cfg.max === null)
    ){
      filteredSystems.push(system);
    }
  });

  filteredSystems.sort(function(a, b) { 
      return b.victoryPoints - a.victoryPoints;
  });

  return filteredSystems;
}

function outputFactions(){

  // Output values
  $('.content').append('<div class="faction-div"><h3>Victory Points</h3><div class="faction-vp"></div></div>');
  $('.content').append('<div class="faction-div"><h3>Systems Held</h3><div class="faction-systems"></div></div>');
  $('.content').append('<div class="faction-div"><h3>Victory Trajectory</h3><div class="faction-victory"></div></div>');
  $('.content').append('<div class="faction-div"><h3>Kills Yesterday</h3><div class="faction-kills"></div></div>');

  $('.content').append('<h2>Market</h2>');
  $('.content').append('<div class="market-div" id="lp-exchange-div-sell"><h3>LP Exchange Rate (Lowest Sell)</h3></div>');
  $('#lp-exchange-div-sell').append('<div class="faction-lp-exchanges-sell"></div>');
  $('.content').append('<div class="market-div" id="iskperoutpost-div-sell"><h3>Estimated ISK per Outpost  (Lowest Sell)</h3></div>');
  $('#iskperoutpost-div-sell').append('<div class="faction-iskpersites-sell"></div>');
  outputLPExchange('sell');

  $('.content').append('<div class="market-div" id="lp-exchange-div-buy"><h3>LP Exchange Rate (Highest Buy)</h3></div>');
  $('#lp-exchange-div-buy').append('<div class="faction-lp-exchanges-buy"></div>');
  $('#lp-exchange-div-buy').append('<p class="heading-note"><b>Note:</b> Based on the highest Jita Price in a selected basket of goods. For purchasing required items "Lowest sell" actually uses "Highest Buy" and vice versa. I.e. it assumes you are either insta-buying or using buy/sell orders for the complete process. More goods will be added to the basket soon!</p>');
  $('.content').append('<div class="market-div" id="iskperoutpost-div-buy"><h3>Estimated ISK per Outpost(Highest Buy)</h3></div>');
  $('#iskperoutpost-div-buy').append('<div class="faction-iskpersites-buy"></div>');
  $('#iskperoutpost-div-buy').append('<p class="heading-note"><b>Note:</b> Estimated faction tier based on systems occupied (system upgrade data is not available). ISK based on capturing an enemy held novice outpost solo.</p>');
  outputLPExchange('buy');

  factions.sort(function(a, b) { 
      return fwSystemsList.factions.totals.victoryPointsPercent[b] - fwSystemsList.factions.totals.victoryPointsPercent[a];
  });
  $.each(factions, function(index, faction){
    var width = fwSystemsList.factions.totals.victoryPointsPercent[faction];
    $('.faction-vp').append('<div class="faction-vp-progress occupier-' + faction + '" style="width: ' 
      + (width - 2) + '%;">'+ factionFullName[faction] + '<br/>' + width.toFixed(2) + '%</div>');
  });

  factions.sort(function(a, b) { 
      return fwSystemsList.factions.totals.occupiedSystemsPercent[b] - fwSystemsList.factions.totals.occupiedSystemsPercent[a];
  });
  $.each(factions, function(index, faction){
    var width = fwSystemsList.factions.totals.occupiedSystemsPercent[faction];
    $('.faction-systems').append('<div class="faction-systems-progress occupier-' + faction + '" style="width: ' 
        + (width - 2) + '%;">' + factionFullName[faction] + '<br/>' + fwSystemsList.factions.totals.occupiedSystems[faction] + ' systems ('
        + width.toFixed(2)+'%)</div>');
  });

  factions.sort(function(a, b) { 
      return fwSystemsList.factions.totals.victoryIndex[b] - fwSystemsList.factions.totals.victoryIndex[a];
  });
  $.each(factions, function(index, faction){
    var width = fwSystemsList.factions.totals.victoryIndex[faction] / fwSystemsList.factions.totals.victoryIndex[factions[0]] * 50;
    var positive = 'positive';
    var left = 50;
    if (width < 0){
      positive = 'negative';
      width = width * -1;
      left = left - width;
    }
    $('.faction-victory').append('<div class="faction-victory-index occupier-' + faction 
      + ' ' + positive + '" style="width: ' + (width - 2) + '%;left:' + left + '%;">' 
      + factionFullName[faction] + '<br/>' 
      + fwSystemsList.factions.totals.victoryIndex[faction].toFixed(2) + '</div>');
  });
}

function outputRegions(){
  var regionsArr = [];
  $.each(fwSystemsList.regions, function(name, region){
    region.name = name;
    regionsArr.push(region);
  });
  regionsArr.sort(function(a, b) { 
    return b.volatility - a.volatility;
  });
  $.each(regionsArr, function(index, region){
    var topFaction = 'minmatar';
    $.each(region.victoryPoints, function(faction, points){
      if (region.victoryPoints[topFaction] < points){
        topFaction = faction;
      }
    });
    var regionDiv = $('<div class="region" data-href="' 
    + dotlanMapURL[topFaction] + region.name +'"></div>'),
    regionVPDiv = $('<div></div>'),
    regionSystemDiv = $('<div></div>');
    $.each(enemy, function(faction, enemy){
      var width = 100 * (fwSystemsList.regions[region.name].victoryPoints[faction] / fwSystemsList.regions[region.name].victoryPointThreshold);
      width = width > 100 ? 100 : width;
      if (width > 0){
        regionVPDiv.append('<div class="region-vp-progress occupier-' + faction + '" style="width: ' + width.toFixed(2) 
          + '%;">' + width.toFixed(2) + '%</div>');
      }
      width = 100 * (fwSystemsList.regions[region.name].occupiedSystems[faction] / fwSystemsList.regions[region.name].systems.length);
      width = width > 100 ? 100 : width;
      if (width > 0){
        regionSystemDiv.append('<div class="region-systems-progress occupier-' + faction + '" style="width: ' 
          + width + '%;">' + fwSystemsList.regions[region.name].occupiedSystems[faction] + ' systems</div>');
      }
    });
    regionDiv.append(regionSystemDiv);
    regionDiv.append(regionVPDiv);
    regionDiv.append('<p>' + region.name + '</p>');
    $('.content').append(regionDiv);
  });
}

function outputConstellations(){
  var constellationsArr = [];
  $.each(fwSystemsList.constellations, function(name, constellation){
    constellation.name = name;
    constellationsArr.push(constellation);
  });
  constellationsArr.sort(function(a, b) { 
    return b.volatility - a.volatility;
  });
  $.each(constellationsArr, function(index, constellation){
    var topFaction = 'minmatar';
    $.each(constellation.victoryPoints, function(faction, points){
      if (constellation.victoryPoints[topFaction] < points){
        topFaction = faction;
      }
    });
    var constellationDiv = $('<div class="constellation" data-href="' 
    + dotlanMapURL[topFaction] + constellation.name +'"></div>'),
    constellationVPDiv = $('<div></div>'),
    constellationSystemDiv = $('<div></div>');
    $.each(enemy, function(faction, enemy){
      var width = 100 * (fwSystemsList.constellations[constellation.name].victoryPoints[faction] / fwSystemsList.constellations[constellation.name].victoryPointThreshold);
      width = width > 100 ? 100 : width;
      if (width > 0){
        constellationVPDiv.append('<div class="constellation-vp-progress occupier-' + faction + '" style="width: ' + width.toFixed(2) 
          + '%;">' + width.toFixed(2) + '%</div>');
      }
      width = 100 * (fwSystemsList.constellations[constellation.name].occupiedSystems[faction] / fwSystemsList.constellations[constellation.name].systems.length);
      width = width > 100 ? 100 : width;
      if (width > 0){
        constellationSystemDiv.append('<div class="constellation-systems-progress occupier-' + faction + '" style="width: ' 
          + width + '%;">' + fwSystemsList.constellations[constellation.name].occupiedSystems[faction] + ' systems</div>');
      }
    });
    constellationDiv.append(constellationSystemDiv);
    constellationDiv.append(constellationVPDiv);
    constellationDiv.append('<p>' + constellation.name + 
      '<br/><span class="definition-label">' + constellation.region + '</span></p>');
    $('.content').append(constellationDiv);
  });
}

function outputSystems(systems, cfg){
  if (systems.length === 0){
    return;
  }
  $('.content').append('<h3>' + cfg.name + '</h3>');
  $.each(systems, function(index, system){
    var contestedLevel = 100 * (system.victoryPoints / system.victoryPointThreshold);
    contestedLevel = contestedLevel.toFixed(2);
    var message = '<b>'+ system.solarSystemName + '</b>: ' + contestedLevel + '%.<br/>';
    message += '<span class="system-owner-label">' + system.occupyingFactionName + ' (' + system.owningFactionName + ')</span>';
    appendMessage(message, system);
  });
}

function appendMessage(message, cfg){
  var contestedLevel = 100 * (cfg.victoryPoints / cfg.victoryPointThreshold);
  contestedLevel = contestedLevel > 100 ? 100 : contestedLevel;
  var paragraph  = $('<div class="message" data-href="' 
    + dotlanMapURL[factionShortlName[cfg.occupyingFactionName]] + cfg.solarSystemName +'"></div>');
  paragraph.append('<div class="system-vp-progress" style="width: ' + contestedLevel + '%;">&nbsp;</div>');
  paragraph.append('<p>' + message + '</p>');

  var region = fwSystemsList.systems[cfg.solarSystemName].region,
  constellation = fwSystemsList.systems[cfg.solarSystemName].constellation;

  var regionDiv = $('<div class="system-region"></div>'),
  regionVPDiv = $('<div></div>'),
  regionSystemDiv = $('<div></div>');
  $.each(enemy, function(faction, enemy){
    var width = 100 * (fwSystemsList.regions[region].victoryPoints[faction] / fwSystemsList.regions[region].victoryPointThreshold);
    width = width > 100 ? 100 : width;
    if (width > 0){
      regionVPDiv.append('<div class="region-vp-progress occupier-' + faction + '" style="width: ' + width.toFixed(2) 
        + '%;">' + width.toFixed(2) + '%</div>');
    }
    width = 100 * (fwSystemsList.regions[region].occupiedSystems[faction] / fwSystemsList.regions[region].systems.length);
    width = width > 100 ? 100 : width;
    if (width > 0){
      regionSystemDiv.append('<div class="region-systems-progress occupier-' + faction + '" style="width: ' 
        + width + '%;">' + fwSystemsList.regions[region].occupiedSystems[faction] + ' systems</div>');
    }
  });
  regionDiv.append(regionSystemDiv);
  regionDiv.append(regionVPDiv);
  regionDiv.append('<p>' + region + '<br/><span class="definition-label">(region)</span></p>');
  paragraph.append(regionDiv);

  var constellationDiv = $('<div class="system-constellation"></div>'),
  constellationVPDiv = $('<div></div>'),
  constellationSystemDiv = $('<div></div>');
  $.each(enemy, function(faction, enemy){
    var width = 100 * (fwSystemsList.constellations[constellation].victoryPoints[faction] 
      / fwSystemsList.constellations[constellation].victoryPointThreshold);
    width = width > 100 ? 100 : width;
    if (width > 0){
      constellationVPDiv.append('<div class="constellation-vp-progress occupier-' + faction 
        + '" style="width: ' + width.toFixed(2) + '%;">' 
        + width.toFixed(2) + '%</div>');
    }
    width = 100 * (fwSystemsList.constellations[constellation].occupiedSystems[faction] 
      / fwSystemsList.constellations[constellation].systems.length);
    width = width > 100 ? 100 : width;
    if (width > 0){
      constellationSystemDiv.append('<div class="constellation-systems-progress occupier-' + faction 
        + '" style="width: ' + width + '%;">' + fwSystemsList.constellations[constellation].occupiedSystems[faction] + ' systems</div>');
    }
  });
  constellationDiv.append(constellationSystemDiv);
  constellationDiv.append(constellationVPDiv);
  constellationDiv.append('<p>' + constellation + '<br/><span class="definition-label">(constellation)</span></p>');
  paragraph.append(constellationDiv);

  paragraph.addClass('occupier-' + cfg.occupyingFactionName.split(' ')[0].toLowerCase());
  paragraph.addClass('owner-' + cfg.owningFactionName.split(' ')[0].toLowerCase());
  $('.content').append(paragraph);
}

// Market functions
function outputLPExchange(type){
  var baskets = {
    'minmatar': [
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Republic Fleet Carbonized Lead S': {id: 28328, requiredIds: [178]},
          'Republic Fleet Depleted Uranium S': {id: 28336, requiredIds: [181]},
          'Republic Fleet EMP S': {id: 21898, requiredIds: [185]},
          'Republic Fleet Fusion S': {id: 21906, requiredIds: [183]},
          'Republic Fleet Nuclear S': {id: 21914, requiredIds: [179]},
          'Republic Fleet Phased Plasma S': {id: 21924, requiredIds: [184]},
          'Republic Fleet Proton S': {id: 21931, requiredIds: [180]},
          'Republic Fleet Titanium Sabot S': {id: 21939, requiredIds: [182]}
        }
      },
      {
        LPCost: 1600,
        ISKCost: 1600000,
        quantity: 5000,
        items: {
          'Republic Fleet Carbonized Lead M': {id: 28326, requiredIds: [186]},
          'Republic Fleet Depleted Uranium M': {id: 28334, requiredIds: [189]},
          'Republic Fleet EMP M': {id: 21896, requiredIds: [193]},
          'Republic Fleet Fusion M': {id: 21904, requiredIds: [191]},
          'Republic Fleet Nuclear M': {id: 21912, requiredIds: [187]},
          'Republic Fleet Phased Plasma M': {id: 21922, requiredIds: [192]},
          'Republic Fleet Proton M': {id: 21928, requiredIds: [188]},
          'Republic Fleet Titanium Sabot M': {id: 21937, requiredIds: [190]}
        }
      },
      {
        LPCost: 2400,
        ISKCost: 2400000,
        quantity: 5000,
        items: {
          'Republic Fleet Carbonized Lead L': {id: 28324, requiredIds: [194]},
          'Republic Fleet Depleted Uranium L': {id: 28332, requiredIds: [197]},
          'Republic Fleet EMP L': {id: 21894, requiredIds: [201]},
          'Republic Fleet Fusion L': {id: 21902, requiredIds: [199]},
          'Republic Fleet Nuclear L': {id: 21910, requiredIds: [195]},
          'Republic Fleet Phased Plasma L': {id: 21918, requiredIds: [200]},
          'Republic Fleet Proton L': {id: 21926, requiredIds: [196]},
          'Republic Fleet Titanium Sabot L': {id: 21935, requiredIds: [198]}
        }
      },
      {
        LPCost: 250,
        ISKCost: 250000,
        quantity: 5,
        items: {
          'Datacore - Hydromagnetic Physics': {id: 20171, requiredIds: []},
          'Datacore - Mechanical Engineering': {id: 20424, requiredIds: []},
          'Datacore - Minmatar Starship Engineering': {id: 20172, requiredIds: []},
          'Datacore - Molecular Engineering': {id: 20415, requiredIds: []},
          'Datacore - Nuclear Physics': {id: 20423, requiredIds: []}
        }
      },
      {
        LPCost: 250000,
        ISKCost: 0,
        quantity: 1,
        items: {
          'Typhoon Fleet Issue': {id: 17713, requiredIds: [644, 17814]},
          'Tempest Fleet Issue': {id: 17732, requiredIds: [639, 17814]}
        }
      },
      {
        LPCost: 45000,
        ISKCost: 0,
        quantity: 1,
        items: {
          'Stabber Fleet Issue': {id: 17713, requiredIds: [622, 17816]},
          'Scythe Fleet Issue': {id: 29336, requiredIds: [631, 17816]}
        }
      },
      {
        LPCost: 10000,
        ISKCost: 0,
        quantity: 1,
        items: {
          'Republic Fleet Firetail': {id: 17812, requiredIds: [587, 17815]}
        }
      }
    ],
    'amarr': [
      {
        LPCost: 1350,
        ISKCost: 1350000,
        quantity: 10,
        items: {
          'Imperial Navy Gamma S': {id: 23073, requiredIds: [245]},
          'Imperial Navy Infrared S': {id: 23081, requiredIds: [241]},
          'Imperial Navy Microwave S': {id: 23083, requiredIds: [240]},
          'Imperial Navy Multifrequency S': {id: 23071, requiredIds: [246]},
          'Imperial Navy Radio S': {id: 23085, requiredIds: [239]},
          'Imperial Navy Xray S': {id: 23075, requiredIds: [244]},
          'Imperial Navy Ultraviolet S': {id: 23077, requiredIds: [243]},
          'Imperial Navy Standard S': {id: 23079, requiredIds: [242]}
        }
      },
      {
        LPCost: 250,
        ISKCost: 250000,
        quantity: 5,
        items: {
          'Datacore - High Energy Physics': {id: 20411, requiredIds: []},
          'Datacore - Mechanical Engineering': {id: 20424, requiredIds: []},
          'Datacore - Amarrian Starship Engineering': {id: 20421, requiredIds: []},
          'Datacore - Nanite Engineering': {id: 20416, requiredIds: []},
          'Datacore - Laser Physics': {id: 20413, requiredIds: []}
        }
      }
    ],
    'gallente': [
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Federation Navy Antimatter Charge S': {id: 22961, requiredIds: [222]},
          'Federation Navy Iridium Charge S': {id: 22971, requiredIds: [217]},
          'Federation Navy Iron Charge S': {id: 22975, requiredIds: [215]},
          'Federation Navy Lead Charge S': {id: 22969, requiredIds: [218]},
          'Federation Navy Plutonium Charge S': {id: 22963, requiredIds: [221]},
          'Federation Navy Uranium Charge S': {id: 22965, requiredIds: [220]},
          'Federation Navy Thorium Charge S': {id: 22967, requiredIds: [219]},
          'Federation Navy Tungsten Charge S': {id: 22973, requiredIds: [216]}
        }
      },
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Federation Navy Antimatter Charge M': {id: 22977, requiredIds: [230]},
          'Federation Navy Iridium Charge M': {id: 22987, requiredIds: [225]},
          'Federation Navy Iron Charge M': {id: 22991, requiredIds: [223]},
          'Federation Navy Lead Charge M': {id: 22985, requiredIds: [226]},
          'Federation Navy Plutonium Charge M': {id: 22979, requiredIds: [229]},
          'Federation Navy Uranium Charge M': {id: 22981, requiredIds: [228]},
          'Federation Navy Thorium Charge M': {id: 22983, requiredIds: [227]},
          'Federation Navy Tungsten Charge M': {id: 22989, requiredIds: [224]}
        }
      },
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Federation Navy Antimatter Charge L': {id: 22993, requiredIds: [238]},
          'Federation Navy Iridium Charge L': {id: 23003, requiredIds: [233]},
          'Federation Navy Iron Charge L': {id: 23007, requiredIds: [231]},
          'Federation Navy Lead Charge L': {id: 23001, requiredIds: [234]},
          'Federation Navy Plutonium Charge L': {id: 22995, requiredIds: [237]},
          'Federation Navy Uranium Charge L': {id: 22997, requiredIds: [236]},
          'Federation Navy Thorium Charge L': {id: 22999, requiredIds: [235]},
          'Federation Navy Tungsten Charge L': {id: 23005, requiredIds: [232]}
        }
      },
      {
        LPCost: 250,
        ISKCost: 250000,
        quantity: 5,
        items: {
          'Datacore - Electromagnetic Physics': {id: 20417, requiredIds: []},
          'Datacore - Mechanical Engineering': {id: 20424, requiredIds: []},
          'Datacore - Gallentean Starship Engineering': {id: 20410, requiredIds: []},
          'Datacore - Electronic Engineering': {id: 20418, requiredIds: []},
          'Datacore - Plasma Physics': {id: 20412, requiredIds: []}
        }
      }
    ],
    'caldari': [
      { 
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Caldari Navy Antimatter Charge S': {id: 23009, requiredIds: [222]},
          'Caldari Navy Iridium Charge S': {id: 23019, requiredIds: [217]},
          'Caldari Navy Iron Charge S': {id: 23023, requiredIds: [215]},
          'Caldari Navy Lead Charge S': {id: 23017, requiredIds: [218]},
          'Caldari Navy Plutonium Charge S': {id: 23011, requiredIds: [221]},
          'Caldari Navy Uranium Charge S': {id: 23013, requiredIds: [220]},
          'Caldari Navy Thorium Charge S': {id: 23015, requiredIds: [219]},
          'Caldari Navy Tungsten Charge S': {id: 23021, requiredIds: [216]}
        }
      },
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Caldari Navy Antimatter Charge M': {id: 23025, requiredIds: [230]},
          'Caldari Navy Iridium Charge M': {id: 23035, requiredIds: [225]},
          'Caldari Navy Iron Charge M': {id: 23039, requiredIds: [223]},
          'Caldari Navy Lead Charge M': {id: 23033, requiredIds: [226]},
          'Caldari Navy Plutonium Charge M': {id: 23027, requiredIds: [229]},
          'Caldari Navy Uranium Charge M': {id: 23029, requiredIds: [228]},
          'Caldari Navy Thorium Charge M': {id: 23031, requiredIds: [227]},
          'Caldari Navy Tungsten Charge M': {id: 23037, requiredIds: [224]}
        }
      },
      {
        LPCost: 1200,
        ISKCost: 1200000,
        quantity: 5000,
        items: {
          'Caldari Navy Antimatter Charge L': {id: 21740, requiredIds: [238]},
          'Caldari Navy Iridium Charge L': {id: 23049, requiredIds: [233]},
          'Caldari Navy Iron Charge L': {id: 23053, requiredIds: [231]},
          'Caldari Navy Lead Charge L': {id: 23047, requiredIds: [234]},
          'Caldari Navy Plutonium Charge L': {id: 23041, requiredIds: [237]},
          'Caldari Navy Uranium Charge L': {id: 23043, requiredIds: [236]},
          'Caldari Navy Thorium Charge L': {id: 23045, requiredIds: [235]},
          'Caldari Navy Tungsten Charge L': {id: 23051, requiredIds: [232]}
        }
      },
      {
        LPCost: 5500,
        ISKCost: 5500000,
        quantity: 5000,
        items: {
          'Caldari Navy Inferno Rocket': {id: 27315, requiredIds: [2514]},
          'Caldari Navy Mjolnir Rocket': {id: 27321, requiredIds: [2512]},
          'Caldari Navy Nova Rocket': {id: 27327, requiredIds: [2516]},
          'Caldari Navy Scourge Rocket': {id: 27333, requiredIds: [266]}
        }
      },
      {
        LPCost: 250,
        ISKCost: 250000,
        quantity: 5,
        items: {
          'Datacore - Graviton Physics': {id: 20419, requiredIds: []},
          'Datacore - Mechanical Engineering': {id: 20424, requiredIds: []},
          'Datacore - Caldari Starship Engineering': {id: 25887, requiredIds: []},
          'Datacore - Rocket Science': {id: 20420, requiredIds: []},
          'Datacore - Quantum Physics': {id: 20414, requiredIds: []}
        }
      }
    ]
  };

  var cfg = {
    type: type
  };
  if (type == 'buy'){
    cfg.aggregation = 'max';
  }
  if (type == 'sell'){
    cfg.aggregation = 'min';
  }
  getBestLPExchangeForTypeByFaction(
    baskets, 
    cfg,
    function(bestLPExchanges){
      $.each(bestLPExchanges, function(index, bestLPExchange){
        var width = (bestLPExchange.exchange / bestLPExchanges[0].exchange) * 100;
        width = width.toFixed(2);
        $('.faction-lp-exchanges-' + type)
          .append(
            '<div class="faction-lp-exchange occupier-' + bestLPExchange.faction + '" style="width: ' + width
          + '%;">'+ bestLPExchange.name + '<br/>' + bestLPExchange.exchange.toFixed(2) + ' ISK / LP</div>'
          );

        var adjustedOccupiedSystemsPercent = fwSystemsList.factions.totals.occupiedSystemsPercent[bestLPExchange.faction] * fwSystemsList.factions.totals.occupiedSystemsPercent[bestLPExchange.faction] / 100;
        adjustedOccupiedSystemsPercent = adjustedOccupiedSystemsPercent == 100 ? 99 : adjustedOccupiedSystemsPercent;
        var estimatedLevel = Math.floor(adjustedOccupiedSystemsPercent / 20);
        var lpByTier = [5000, 10000, 17500, 25000, 32500];
        bestLPExchanges[index].estimatedTier = estimatedLevel + 1;
        bestLPExchanges[index].iskpersite = lpByTier[estimatedLevel] * bestLPExchange.exchange;
      });

      bestLPExchanges.sort(function(a, b) { 
        return b.iskpersite - a.iskpersite;
      });
      $.each(bestLPExchanges, function(index, bestLPExchange){
        var width = (bestLPExchange.iskpersite / bestLPExchanges[0].iskpersite) * 100;
        width = width.toFixed(2);
        $('.faction-iskpersites-' + type)
          .append(
            '<div class="faction-lp-iskpersite occupier-' + bestLPExchange.faction + '" style="width: ' + width
          + '%;">'+ factionFullName[bestLPExchange.faction] + ' (' + bestLPExchanges[index].estimatedTier + ')<br/>' 
          + numberWithCommas(bestLPExchange.iskpersite.toFixed(2)) + ' ISK</div>'
          );
      });
    }
  );
}

function getBestLPExchangeForTypeByFaction(factionBaskets, cfg, callback){
  var basketCount = 0;
  var bestLPExchanges = [];
  $.each(factionBaskets, function(faction, baskets){
    $.each(baskets, function(index, basket){
      basketCount++;
      getBasketPrices(basket.items, {
        faction: faction, 
        index: index, 
        type: cfg.type,
        aggregation: cfg.aggregation
      }, returnBestLPExchange);
    });
  });

  function returnBestLPExchange(priceList, rtnCfg){
    var totalRequiredItemCost = 0;
    var item = priceList[0];
    $.each(item.requiredItemPrices, function(requiredItemPrice){
      totalRequiredItemCost += requiredItemPrice;
    });
    item.exchange = (
      (
        (
          item.price - totalRequiredItemCost
        ) * factionBaskets[rtnCfg.faction][rtnCfg.index].quantity
      ) - factionBaskets[rtnCfg.faction][rtnCfg.index].ISKCost
    ) / factionBaskets[rtnCfg.faction][rtnCfg.index].LPCost;

    item.faction = rtnCfg.faction;
    bestLPExchanges.push(item);
    if (basketCount === bestLPExchanges.length) {
      bestLPExchanges.sort(function(a, b) { 
        return b.exchange - a.exchange;
      });
      bestLPExchanges = filterBestPerfaction(bestLPExchanges);
      callback(bestLPExchanges);
    }
  }
}

function filterBestPerfaction(bestLPExchanges){
  var found = {
    'amarr': false,
    'minmatar': false,
    'gallente': false,
    'caldari': false
  };

  return bestLPExchanges.filter(function(LPExchange){
      if (found[LPExchange.faction] === true){
        return false;
      } 
      found[LPExchange.faction] = true;
      return true;
  });
}

function getBasketPrices(basket, cfg, callback){
  var priceList = [];
  var basketLength = Object.keys(basket).length;
  $.each(basket, function(itemName, item){
    item.name = itemName;
    getItemAndRequiredItemPrices(item, cfg, returnBasketPrices)
  });

  function returnBasketPrices(item){
    priceList.push(item);
    if (priceList.length === basketLength){
      priceList.sort(function(a, b) { 
        return b.price - a.price;
      });
      callback(priceList, cfg);
    }
  }
}

function getItemAndRequiredItemPrices(item, cfg, callback){
  item.requiredItemPrices = [];
  getItemPrice({id: item.id, name: item.name}, cfg, returnItemAndRequiredItemPrices);
  $.each(item.requiredIds, function(index, id){
    var requiredCfg = {};
    if (cfg.type == "buy"){
      requiredCfg.type = "sell";
      requiredCfg.aggregation = "min";
    }
    if (cfg.type == "sell"){
      requiredCfg.type = "buy";
      requiredCfg.aggregation = "max";
    }
    getItemPrice({id: id, name: item.name}, requiredCfg, returnItemAndRequiredItemPrices);
  });
  function returnItemAndRequiredItemPrices(rtnItem){
    if (rtnItem.id === item.id){
      item.price = rtnItem.price;
    }
    $.each(item.requiredIds, function(index, id){
      if (rtnItem.id === id){
        item.requiredItemPrices.push(rtnItem.price);
      }
    });

    if (item.hasOwnProperty('price') && item.requiredItemPrices.length == item.requiredIds.length){
      callback(item);
    }
  }
}

function getItemPrice(item, cfg, callback){
  //Default to Jita.
  if (!cfg.hasOwnProperty('usesystem')){
    cfg.usesystem = '30000142'; 
  }

  // Default to lowest sell
  if (!cfg.hasOwnProperty('type')){
    cfg.type = 'sell'; 
  }
  if (!cfg.hasOwnProperty('aggregation')){
    cfg.aggregation = 'min'; 
  }

  var jqxhr = $.get( 
    "https://api.eve-central.com/api/marketstat/json?typeid=" + item.id +'&usesystem=' + cfg.usesystem, 
    function(json) {
      item.price = json[0][cfg.type][cfg.aggregation];
      callback(item);
  })
  .fail(function() {
    console.log('Failed to get price for ' + item.name);
  });
}

// Utility Functions
function dateToTimeString(date){
  return numberFormat(date.getHours(),2) + ':' + numberFormat(date.getMinutes(),2) + ':' + numberFormat(date.getSeconds(),2);
}

function numberFormat(number, width) {
    return new Array(+width + 1 - (number + '').length).join('0') + number;
}

function numberWithCommas(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

</script>
</html>